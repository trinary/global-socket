"use strict";function latLongToVector3(lat,lon,radius){var phi=lat*Math.PI/180,theta=(lon-180)*Math.PI/180,x=-radius*Math.cos(phi)*Math.cos(theta),y=radius*Math.sin(phi),z=radius*Math.cos(phi)*Math.sin(theta);return[x,y,z]}function addTweet(tweet){if(tweet.location&&tweet.location.geo){var color,geo=tweet.geo||tweet.location.geo,pos=[];color=tweet.inReplyTo?13199798:15573544;var marker=new THREE.Mesh(new THREE.BoxGeometry(.1,.1,1),new THREE.MeshBasicMaterial({transparent:!0,color:color}));"Point"===geo.type?pos=geo.coordinates:"Polygon"===geo.type&&(pos=[(geo.coordinates[0][0][1]+geo.coordinates[0][1][1]+geo.coordinates[0][2][1]+geo.coordinates[0][3][1])/4,(geo.coordinates[0][0][0]+geo.coordinates[0][1][0]+geo.coordinates[0][2][0]+geo.coordinates[0][3][0])/4]);var coords=latLongToVector3(pos[0],pos[1],10);console.log(pos,coords),marker.position.fromArray(coords),marker.lookAt(origin),markers.push({mesh:marker,start:new Date}),scene.add(marker)}}var socket=io.connect("http://127.0.0.1:7008/"),width=window.innerWidth,height=window.innerHeight,rotation=[0,-Math.PI/2],markers=[],scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(75,width/height,.1,1e3),duration=9e4,origin=new THREE.Vector3(0,0,0),renderer=new THREE.WebGLRenderer;renderer.setSize(width,height);var geometry=new THREE.SphereGeometry(10,64,64),material=new THREE.MeshPhongMaterial({map:THREE.ImageUtils.loadTexture("/img/2_no_clouds_8k.jpg")}),light=new THREE.DirectionalLight(16777215);light.position.set(0,15,15).normalize(),scene.add(light);var globe=new THREE.Mesh(geometry,material);scene.add(globe),camera.position.z=20;var render=function(){requestAnimationFrame(render);var timer=1e-4*Date.now(),camerapos=[20*Math.cos(timer),12*Math.sin(2*timer),20*Math.sin(timer)];markers.forEach(function(m){var age=new Date-m.start,ratio=(duration-age)/duration;m.mesh.material.opacity=ratio,m.mesh.material.opacity<0&&(scene.remove(m.mesh),m=void 0)}),markers=markers.filter(function(m){return void 0!==m}),camera.position.fromArray(camerapos),light.position.fromArray(camerapos),camera.lookAt(origin),renderer.render(scene,camera)};render(),document.body.appendChild(renderer.domElement),socket.on("tweet",addTweet);